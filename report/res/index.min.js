define(["exports","@hpcc-js/comms","@hpcc-js/layout","@hpcc-js/other","@hpcc-js/phosphor","@hpcc-js/html","@hpcc-js/chart","@hpcc-js/common"],function(t,e,i,n,r,a,o,l){"use strict";var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function u(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var h=l.Palette.rainbow("Blues"),d=l.Palette.ordinal("Quartile",[h(100,0,100),h(50,0,100),h(50,0,100),h(75,0,100)]);d("Std. Dev."),d("MinMax"),d("25%"),d("50%");var c=20,p=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return u(e,t),e}(o.Scatter);p.prototype.publishProxy("xAxisTicks","domainAxis","ticks");var f=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._bellCurve=(new p).columns(["","Std. Dev."]).paletteID("Quartile").interpolate_default("basis").pointSize(0).xAxisType("linear").xAxisOverlapMode("none").xAxisTickFormat(".2s").yAxisHidden(!0).yAxisDomainLow(0).yAxisDomainHigh(110).yAxisGuideLines(!1),e._candle=(new o.QuartileCandlestick).columns(["Min","25%","50%","75%","Max"]).edgePadding(0).candleWidth(c-4).roundedCorners(1).lineWidth(1).upperTextRotation(-90).lowerTextRotation(-90).labelFontSize(0).valueFontSize(0).lineColor(h(90,0,100)).innerRectColor(h(10,0,100)),e}return u(e,t),e.prototype.stdDev=function(t){return this.mean()+t*this.standardDeviation()},e.prototype.formatStdDev=function(t){return this._tickFormatter(this.stdDev(t))},e.prototype.quartile=function(t){return this.quartiles()[t]},e.prototype.formatQ=function(t){return this._tickFormatter(this.quartile(t))},e.prototype.domain=function(t){switch(t){case"25_75":return[this.quartile(1),this.quartile(3)];case"normal":return[this.stdDev(-4),this.stdDev(4)];case"min_max":default:return[this.quartile(0),this.quartile(4)]}},e.prototype.enter=function(e,i){var n=this;t.prototype.enter.call(this,e,i),this._bellCurve.target(i.append("div").node()),this._candle.target(i.append("div").node()),this._selectMode=i.append("div").style("position","absolute").style("top","0px").style("right","0px").append("select").on("change",function(){return n.render()}),this._selectMode.append("option").attr("value","min_max").text("Min / Max"),this._selectMode.append("option").attr("value","25_75").text("25% / 75%"),this._selectMode.append("option").attr("value","normal").text("Normal")},e.prototype.bellTicks=function(t){var e;switch(t){case"25_75":e=[{label:this.formatQ(1),value:this.quartile(1)},{label:this.formatQ(2),value:this.quartile(2)},{label:this.formatQ(3),value:this.quartile(3)}];break;case"normal":e=[{label:this.formatStdDev(-4),value:this.stdDev(-4)},{label:"-3σ",value:this.stdDev(-3)},{label:"-2σ",value:this.stdDev(-2)},{label:"-1σ",value:this.stdDev(-1)},{label:this.formatStdDev(0),value:this.stdDev(0)},{label:"+1σ",value:this.stdDev(1)},{label:"+2σ",value:this.stdDev(2)},{label:"+3σ",value:this.stdDev(3)},{label:this.formatStdDev(4),value:this.stdDev(4)}];break;case"min_max":default:e=[{label:this.formatQ(0),value:this.quartile(0)},{label:this.formatQ(1),value:this.quartile(1)},{label:this.formatQ(2),value:this.quartile(2)},{label:this.formatQ(3),value:this.quartile(3)},{label:this.formatQ(4),value:this.quartile(4)}]}var i=this.domain(this._selectMode.node().value),n=i[0],r=i[1];return e.filter(function(t){return t.value>=n&&t.value<=r}).map(function(t){return{label:t.label,value:t.value.toString()}})},e.prototype.updateBellCurve=function(){var t=this._selectMode.node().value,e=this.domain(t),i=e[0],n=e[1],r=.1*(n-i);this._bellCurve.xAxisDomainLow(i-r).xAxisDomainHigh(n+r).xAxisTicks(this.bellTicks(t)).data([[this.stdDev(-4),0],[this.stdDev(-3),.3],[this.stdDev(-2),5],[this.stdDev(-1),68],[this.stdDev(0),100],[this.stdDev(1),68],[this.stdDev(2),5],[this.stdDev(3),.3],[this.stdDev(4),0]]).resize({width:this.width(),height:this.height()-c}).render()},e.prototype.updateCandle=function(){var t=this._bellCurve.dataPos(this.quartile(0)),e=this._bellCurve.dataPos(this.quartile(4))-t;this._candle.resize({width:this.width(),height:c}).pos({x:t+e/2,y:c/2}).width(e).data(this.quartiles()).render()},e.prototype.update=function(e,i){var n,r;t.prototype.update.call(this,e,i),this._tickFormatter=(n=this.tickFormat(),r=l.format(n),function(t){var e=(Math.round(100*t)/100).toString();return e.length<=4?e:r(t)}),this.updateBellCurve(),this.updateCandle()},e}(l.HTMLWidget);f.prototype.publish("tickFormat",".2e","string","X-Axis Tick Format"),f.prototype.publish("mean",0,"number","Mean"),f.prototype.publish("standardDeviation",0,"number","Standard Deviation"),f.prototype.publish("quartiles",[0,0,0,0,0],"array","Quartiles");var m=function(t){return["attribute","given_attribute_type","best_attribute_type","rec_count","fill_count","fill_rate","cardinality","cardinality_breakdown","modes","min_length","max_length","ave_length","popular_patterns","rare_patterns","is_numeric","numeric_min","numeric_max","numeric_mean","numeric_std_dev","numeric_lower_quartile","numeric_median","numeric_upper_quartile","numeric_correlations"].indexOf(t.ColumnName)>0},_=function(t){return function(t){return t.ECLSchemas.ECLSchemaItem.filter(m).length}(t)>=4},v={rowHeight:190,colRatios:{attributeDesc:1,statsData:1,breakdown:2/3,quartile:1,popularPatterns:1},primaryFontSize:20,secondaryFontSize:14,primaryColor:"#494949",secondaryColor:"#DDD",offwhiteColor:"#FBFBFB",blueColor:"#1A99D5",redColor:"#ED1C24",fillRateRedThreshold:33},w=function(t){function i(i){var n=t.call(this)||this;n._espUrl=i,n.hideSingleTabs(!0);var r=n._espUrl.split("/WsWorkunits/res/"),a=r[0],o=r[1].split("/report/res/index.html")[0];return n._wu=e.Workunit.attach({baseUrl:a},o),n}return u(i,t),i.prototype.render=function(e){var i=this;return this._wu.fetchResults().then(function(n){Promise.all(n.filter(_).map(function(t){return t.fetchRows().then(function(e){return{result:t,report:new y(e)}})})).then(function(n){n.forEach(function(t,e){0===e?i.addWidget(t.report,t.result.Name):i.addWidget(t.report,t.result.Name,"tab-after",n[e-1].report)}),t.prototype.render.call(i,function(t){e&&e(i)})})}),this},i}(r.DockPanel),y=function(t){function e(e){var i=t.call(this)||this;return i._showBreakdownColumn=!0,i._showPopularPatternsColumn=!0,i._showQuartileColumn=!0,i._data=e,i.gutter(12).surfaceShadow(!1).surfacePadding("0").surfaceBorderWidth(0),i}return u(e,t),e.prototype.enter=function(e,i){var n=this;this._fixedHeight=this._data.length*v.rowHeight,e.style.height=this._fixedHeight+"px",this.height(this._fixedHeight),t.prototype.enter.call(this,e,i);var r=this.calcStatsWidgetDataColumnWidth();this._showQuartileColumn=this._data.filter(function(t){return t.is_numeric}).length>0,this._showBreakdownColumn=this._data.filter(function(t){return t.cardinality_breakdown.Row.length>0}).length>0,this._showPopularPatternsColumn=this._data.filter(function(t){return t.popular_patterns.Row.length>0}).length>0;var a=3;this._data.forEach(function(t,e){var i=n.enterDataRow(t,e,{statsDataWidth:r});i>a&&(a=i)}),i.classed("report-col-count-"+a,!0)},e.prototype.enterDataRow=function(t,e,r){var o=e*v.rowHeight,l=2,s=0;return this.setContent(o,s,u(t),void 0,v.rowHeight,12*v.colRatios.attributeDesc),s+=12*v.colRatios.attributeDesc,this.setContent(o,s,function(t,e){if(t.is_numeric)return(new a.StyledTable).data([["Mean",t.numeric_mean,""],["Std. Deviation",t.numeric_std_dev,""],["","",""],["Quartiles",t.numeric_min,"Min"],["",t.numeric_lower_quartile,"25%"],["",t.numeric_median,"50%"],["",t.numeric_upper_quartile,"75%"],["",t.numeric_max,"Max"]]).tbodyColumnStyles([{"font-weight":"bold","text-align":"right",width:"100px"},{"font-weight":"normal",width:e+"px"},{"font-weight":"normal",width:"auto"}]);if(t.popular_patterns.Row.length>0)return(new a.StyledTable).data([["Min Length",t.min_length],["Avg Length",t.ave_length],["Max Length",t.max_length]]).tbodyColumnStyles([{"font-weight":"bold","text-align":"right",width:"100px"},{"font-weight":"normal",width:"auto"}]);return u(t)}(t,r.statsDataWidth),void 0,v.rowHeight,12*v.colRatios.statsData),s+=12*v.colRatios.statsData,this._showQuartileColumn&&(this.setContent(o,s,function(t){return t.is_numeric?(new f).mean(t.numeric_mean).standardDeviation(t.numeric_std_dev).quartiles([t.numeric_min,t.numeric_lower_quartile,t.numeric_median,t.numeric_upper_quartile,t.numeric_max]):h("Quartile","N/A")}(t),void 0,v.rowHeight,12*v.colRatios.quartile),s+=12*v.colRatios.quartile,++l),this._showBreakdownColumn&&(this.setContent(o,s,function(t){return t.cardinality_breakdown.Row.length>0?(new a.BreakdownTable).columns(["Cardinality",""]).data(t.cardinality_breakdown.Row.map(function(t){return[t.value.trim(),t.rec_count]})).theadColumnStyles([{"text-align":"left","font-size":v.secondaryFontSize+"px","white-space":"nowrap"}]).tbodyColumnStyles([{"max-width":"60px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"},{"text-align":"right","font-size":v.secondaryFontSize+"px"}]):h("Cardinality Breakdown","N/A")}(t),void 0,v.rowHeight,12*v.colRatios.breakdown),s+=12*v.colRatios.breakdown,++l),this._showPopularPatternsColumn&&(this.setContent(o,s,function(t){return t.popular_patterns.Row.length>0?(new a.BreakdownTable).columns(["Popular Patterns",""]).theadColumnStyles([{"text-align":"left","font-size":v.secondaryFontSize+"px","white-space":"nowrap"}]).tbodyColumnStyles([{"max-width":"60px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"},{"text-align":"right","font-size":v.secondaryFontSize+"px"}]).data(t.popular_patterns.Row.map(function(t){return[t.data_pattern.trim(),t.rec_count]})):h("Popular Patterns","N/A")}(t),void 0,v.rowHeight,12*v.colRatios.popularPatterns),s+=12*v.colRatios.popularPatterns,++l),l;function u(t){var e=(new n.Html).html('<span style="\n                    color:'+v.primaryColor+";\n                    padding:8px;\n                    display:inline-block;\n                    font-size:"+v.secondaryFontSize+"px;\n                    margin-top:4px;\n                    border:1px solid "+v.secondaryColor+";\n                    border-radius:4px;\n                    background-color: "+v.offwhiteColor+';\n                    width: calc(100% - 18px);\n                ">\n                    <i style="\n                        font-size:'+v.secondaryFontSize+"px;\n                        color:"+v.blueColor+';\n                    " class="fa '+("string"===t.given_attribute_type.slice(0,6)?"fa-font":"fa-hashtag")+'"></i>\n                    <b>'+t.attribute+'</b>\n                    <span style="float:right;">'+t.given_attribute_type+'</span>\n                </span>\n                <span style="padding:12px 2px;display:inline-block;font-family: Verdana; color: rgb(51, 51, 51); font-weight: bold; font-size: 14px;">\n                    Optimal:\n                </span>\n                <span style="\n                    color:'+v.primaryColor+";\n                    padding:4px 8px;\n                    display:inline-block;\n                    font-size:"+v.secondaryFontSize+"px;\n                    margin-top:4px;\n                    border:1px solid "+v.secondaryColor+";\n                    border-radius:4px;\n                    background-color: "+v.offwhiteColor+';\n                    float:right;\n                ">\n                    <i style="\n                        font-size:'+v.secondaryFontSize+"px;\n                        color:"+v.blueColor+';\n                    " class="fa '+("string"===t.best_attribute_type.slice(0,6)?"fa-font":"fa-hashtag")+'"></i>\n                    '+t.best_attribute_type+"\n                </span>\n                ").overflowX("hidden").overflowY("hidden"),r=100===t.fill_rate||0===t.fill_rate?t.fill_rate:t.fill_rate.toFixed(1),o=(new a.StyledTable).data([["Cardinality",t.cardinality,"(~"+(t.cardinality/t.fill_count*100).toFixed(0)+"%)"],["Filled",t.fill_count,r<=v.fillRateRedThreshold?'(<b style="color:'+v.redColor+'">'+r+"%</b>)":"("+r+"%)"]]).tbodyColumnStyles([{"font-weight":"bold","font-size":v.secondaryFontSize+"px",width:"1%"},{"font-weight":"normal","font-size":v.secondaryFontSize+"px","text-align":"right",width:"auto"},{"font-weight":"normal","font-size":v.secondaryFontSize+"px","text-align":"left",width:"1%"}]);return(new i.Grid).gutter(0).surfaceShadow(!1).surfacePadding("0").surfaceBorderWidth(0).setContent(0,0,e).setContent(1,0,o)}function h(t,e){return(new n.Html).html('\n                    <b style="line-height:23px;font-size:'+v.secondaryFontSize+'px;color: rgb(51, 51, 51);">'+t+'</b>\n                    <br/>\n                    <i style="font-size:'+v.secondaryFontSize+'px;color: rgb(51, 51, 51);">'+e+"</i>\n                ").overflowX("hidden").overflowY("hidden")}},e.prototype.update=function(e,i){this.height(this._fixedHeight),t.prototype.update.call(this,e,i)},e.prototype.resize=function(e){var i=t.prototype.resize.call(this,e);return this._placeholderElement&&this._placeholderElement.style("height",(this._fixedHeight?this._fixedHeight:this._size.height)+"px"),i},e.prototype.calcStatsWidgetDataColumnWidth=function(){var t=this,e=0;return this._data.forEach(function(i){var n=Math.max(t.textSize(i.numeric_mean).width,t.textSize(i.numeric_std_dev).width,t.textSize(i.numeric_min).width,t.textSize(i.numeric_lower_quartile).width,t.textSize(i.numeric_median).width,t.textSize(i.numeric_upper_quartile).width,t.textSize(i.numeric_max).width);n>e&&(e=n)}),e},e}(i.Grid);t.Report=y,t.ReportTabs=w,Object.defineProperty(t,"__esModule",{value:!0})});